input {
  file {
    path => [
      "/usr/share/logstash/logs/info/*.log",
      "/usr/share/logstash/logs/error/*.log"
    ]
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
  }
}

filter {
  json {
    source => "message"
  }

  if [message][type] == "REQUEST" {
    mutate {
      add_field => {
        "req_method" => "%{[message][method]}"
        "req_path" => "%{[message][path]}"
        "req_query" => "%{[message][query]}"
        "req_body" => "%{[message][body]}"
        "req_headers" => "%{[message][headers]}"
      }
    }
  }

  if [message][type] == "RESPONSE" {
    mutate {
      add_field => {
        "res_status_code" => "%{[message][statusCode]}"
        "res_time" => "%{[message][responseTime]}"
      }
    }
  }

  date {
    match => ["[message][timestamp]", "ISO8601"]
    target => "@timestamp"
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "nestjs-logs-%{+YYYY.MM.dd}"
  }
  stdout { codec => rubydebug }
} 